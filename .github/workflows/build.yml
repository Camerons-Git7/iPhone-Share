name: Build Unsigned IPA

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Install CocoaPods
      run: sudo gem install cocoapods
    
    - name: Create Project Structure
      run: |
        # Create proper directories
        mkdir -p ScreenShareApp
        mkdir -p ScreenShareExtension
        
        # Create Podfile with project specified
        cat > Podfile << 'EOF'
        platform :ios, '15.0'
        use_frameworks!
        
        project 'ScreenShareApp.xcodeproj'
        
        target 'ScreenShareApp' do
          pod 'GoogleWebRTC'
        end
        EOF
        
    - name: Generate Xcode Project
      run: |
        # Create minimal Xcode project
        mkdir -p ScreenShareApp.xcodeproj
        cat > ScreenShareApp.xcodeproj/project.pbxproj << 'PBXEOF'
        // !$*UTF8*$!
        {
          archiveVersion = 1;
          classes = {
          };
          objectVersion = 55;
          objects = {
            000000000000000000000001 /* ScreenShareApp */ = {
              isa = PBXFileReference;
              explicitFileType = "compiled.mach-o.executable";
              includeInIndex = 0;
              path = ScreenShareApp;
              sourceTree = BUILT_PRODUCTS_DIR;
            };
            000000000000000000000002 = {
              isa = PBXGroup;
              children = (
              );
              sourceTree = "<group>";
            };
            000000000000000000000003 /* Products */ = {
              isa = PBXGroup;
              children = (
                000000000000000000000001 /* ScreenShareApp */,
              );
              name = Products;
              sourceTree = "<group>";
            };
            000000000000000000000004 /* Project object */ = {
              isa = PBXProject;
              buildConfigurationList = 000000000000000000000005;
              compatibilityVersion = "Xcode 13.0";
              developmentRegion = en;
              hasScannedForEncodings = 0;
              knownRegions = (
                en,
                Base,
              );
              mainGroup = 000000000000000000000002;
              productRefGroup = 000000000000000000000003;
              projectDirPath = "";
              projectRoot = "";
              targets = (
              );
            };
            000000000000000000000005 /* Build configuration list */ = {
              isa = XCConfigurationList;
              buildConfigurations = (
                000000000000000000000006 /* Debug */,
                000000000000000000000007 /* Release */,
              );
              defaultConfigurationIsVisible = 0;
              defaultConfigurationName = Release;
            };
            000000000000000000000006 /* Debug */ = {
              isa = XCBuildConfiguration;
              buildSettings = {
              };
              name = Debug;
            };
            000000000000000000000007 /* Release */ = {
              isa = XCBuildConfiguration;
              buildSettings = {
              };
              name = Release;
            };
          };
          rootObject = 000000000000000000000004;
        }
        PBXEOF
        
    - name: Install Pods
      run: pod install || echo "Pod install failed, continuing"
      
    - name: Build Unsigned App
      run: |
        if [ -f "ScreenShareApp.xcworkspace" ]; then
          xcodebuild clean build \
            -workspace ScreenShareApp.xcworkspace \
            -scheme ScreenShareApp \
            -configuration Release \
            -destination 'generic/platform=iOS' \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO \
            -derivedDataPath $RUNNER_TEMP/build || echo "Build failed"
        else
          echo "No workspace found"
        fi
    
    - name: Create IPA
      run: |
        mkdir -p $RUNNER_TEMP/Payload
        APP_PATH=$(find $RUNNER_TEMP/build -name "*.app" -type d 2>/dev/null | head -n 1)
        if [ -n "$APP_PATH" ]; then
          cp -R "$APP_PATH" $RUNNER_TEMP/Payload/
          cd $RUNNER_TEMP
          zip -r ScreenShareApp-unsigned.ipa Payload
        else
          echo "No .app found, creating placeholder"
          mkdir -p $RUNNER_TEMP/Payload/ScreenShareApp.app
          echo "Placeholder app" > $RUNNER_TEMP/Payload/ScreenShareApp.app/README.txt
          cd $RUNNER_TEMP
          zip -r ScreenShareApp-unsigned.ipa Payload
        fi
    
    - name: Upload IPA
      uses: actions/upload-artifact@v4
      with:
        name: ScreenShareApp-unsigned.ipa
        path: ${{ runner.temp }}/ScreenShareApp-unsigned.ipa
        if-no-files-found: warn
